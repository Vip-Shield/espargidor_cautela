<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cautela de Espargidores - RUMB</title>
<style>
  /* --- ESTILO GERAL --- */
  * { box-sizing: border-box; }

  body { 
    font-family: 'Segoe UI', Arial, sans-serif; 
    background: #001f3f; 
    color: #fff; 
    margin: 0; 
    padding: 20px; 
    padding-top: 130px; 
    font-size: 11px; 
  }
  
  /* --- CABE√áALHO --- */
  .header { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 110px;
    background: #001f3f; 
    z-index: 1000; 
    padding: 0 15px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-bottom: 3px solid #FF851B; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }

  .logo-img {
    height: 80px; 
    width: auto;
    max-width: 80px;
    object-fit: contain;
    filter: drop-shadow(0px 0px 2px rgba(255,255,255,0.2));
  }

  .titulo { 
    flex-grow: 1; 
    text-align: center; 
    padding: 0 10px;
  }

  .titulo h1 { 
    font-size: 18px; 
    margin: 0; 
    color: #f0f0f0; 
    text-transform: uppercase; 
    letter-spacing: 1px;
  }
  
  .titulo p { 
    margin: 5px 0 0 0; 
    color: #FF851B; 
    font-weight: bold; 
    font-size: 12px;
  }

  /* --- FORMUL√ÅRIO --- */
  .form-container { 
    background: #001226; 
    padding: 20px; 
    border-radius: 8px; 
    border: 1px solid #FF851B; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
    max-width: 1000px; 
    margin: 0 auto; 
  }
  
  .bloco-titulo { 
    background: linear-gradient(90deg, #663300, #001f3f); 
    color: #fff; padding: 6px; font-weight: bold; text-align: center; 
    margin: 15px 0 10px 0; border-left: 5px solid #FF851B;
    text-transform: uppercase; font-size: 12px;
  }

  .grid-campos { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; }
  .campo-grupo { display: flex; flex-direction: column; }
  
  label { font-size: 10px; margin-bottom: 4px; color: #FFDC00; font-weight: bold; }
  input, select { padding: 8px; border-radius: 4px; border: 1px solid #004080; background: #001830; color: #fff; font-size: 12px; width: 100%; }
  input:focus { border-color: #FF851B; outline: none; }
  
  /* --- C√ÇMERA --- */
  .camera-container {
    display: flex; flex-direction: column; align-items: center; gap: 10px;
    background: #000; padding: 10px; border: 1px dashed #FF851B; margin-top: 10px;
    border-radius: 5px;
  }
  video, canvas, #fotoPreview { max-width: 100%; max-height: 200px; border-radius: 4px; }
  .controles-camera { display: flex; gap: 10px; }

  /* --- BOT√ïES --- */
  .btn-area { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  button { padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 4px; border: none; text-transform: uppercase; font-size: 11px; color: white; transition: 0.3s;}
  
  .btn-salvar { background: #FF851B; color: #000; } .btn-salvar:hover { background: #e67700; }
  .btn-camera { background: #0074D9; } .btn-capturar { background: #dc2626; }
  .btn-print { background: #415a77; } 
  .btn-backup { background: #059669; } .btn-restore { background: #dc2626; }
  .btn-filter { background: #b8860b; color: black; }

  /* --- TABELA --- */
  .search-container { margin-top: 20px; margin-bottom: 10px; max-width: 1000px; margin-left: auto; margin-right: auto; }
  #inputBusca { width: 100%; padding: 10px; background: #001226; border: 1px solid #FF851B; color: white; }
  
  .table-wrapper { overflow-x: auto; max-width: 1000px; margin: 0 auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 5px; background: white; color: black; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; vertical-align: middle; font-size: 10px; }
  th { background: #001f3f; color: white; text-transform: uppercase; }
  
  .img-tabela { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #999; cursor: pointer; }
  .img-tabela:hover { transform: scale(3); transition: 0.2s; border: 2px solid #FF851B; z-index: 100; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
  
  .btn-baixa { background: #15803d; color: white; padding: 5px 10px; border-radius: 3px; border:none; cursor: pointer; }

  /* IMPRESS√ÉO */
  @media print {
    .form-container, .btn-area, .search-container, .no-print, .header { display: none; }
    body { background: white; color: black; padding: 0; margin: 0; }
    .header-print { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
    .header-print img { height: 60px; }
    .header-print div { text-align: center; width: 100%; }
    th { background: #ddd !important; color: black; border: 1px solid #000; }
    td { border: 1px solid #000; }
    .img-tabela { width: 30px; height: 30px; }
  }
  .header-print { display: none; }
</style>
</head>
<body>

<div class="header-print">
    <img src="caveira.jpg" alt="RUMB">
    <div>
        <h3>PMERJ - LIVRO DE CAUTELA DE ESPARGIDORES (RUMB)</h3>
    </div>
    <img src="pmerj.png" alt="PMERJ">
</div>

<div class="header">
  <a href="../dashboard.html"><img src="caveira.png" class="logo-img" alt="RUMB" title="Voltar ao Painel"></a>
  <div class="titulo">
    <h1>Pol√≠cia Militar do Estado do Rio de Janeiro</h1>
    <p>LIVRO DE CAUTELA DE ESPARGIDORES (G√ÅS)</p>
  </div>
  <img src="pmerj.png" class="logo-img" alt="PMERJ">
</div>

<div class="form-container">
  <form id="formCautela">
    <div class="bloco-titulo">1. IDENTIFICA√á√ÉO DO POLICIAL</div>
    <div class="grid-campos">
      <div class="campo-grupo">
        <label>RG (Digite para buscar)</label>
        <input type="text" id="rg" list="lista-rgs" required placeholder="00.000" autocomplete="off">
        <datalist id="lista-rgs"></datalist>
      </div>
      <div class="campo-grupo" style="flex-grow: 2;">
        <label>NOME DE GUERRA</label>
        <input type="text" id="nome" list="lista-nomes" required placeholder="Nome do Policial" autocomplete="off">
        <datalist id="lista-nomes"></datalist>
      </div>
      <div class="campo-grupo">
        <label>GH</label>
        <input type="text" id="gh" required placeholder="Ex: SD" class="auto-filled">
      </div>
    </div>

    <div class="bloco-titulo">2. DADOS DO ESPARGIDOR (G√ÅS)</div>
    <div class="grid-campos">
      <div class="campo-grupo"><label>N¬∫ S√âRIE / PATRIM√îNIO</label><input type="text" id="patrimonio" required placeholder="N¬∫ da lata"></div>
      
      <div class="campo-grupo"><label>TIPO / MODELO</label>
        <select id="modelo" required>
	    <option value="G.PIM">G.PIM (OC)</option>
            <option value="GEL">GEL (ALVO DIRECIONADO)</option>
            <option value="ESPUMA">ESPUMA</option>
            <option value="NEVOA">N√âVOA (SPRAY)</option>
            <option value="LACRIMOGENIO">CS (LACRIMOG√äNIO)</option>
            <option value="PSI">PSI (JATO)</option>
        </select>
      </div>

      <div class="campo-grupo"><label>PESO (g)</label><input type="number" id="peso" required placeholder="Ex: 120" step="any"></div>
      
      <div class="campo-grupo"><label>VALIDADE</label><input type="month" id="validade"></div>
    </div>

    <div class="camera-container">
        <label style="color:white">FOTO DO MATERIAL (ESTADO DE CONSERVA√á√ÉO)</label>
        <video id="video" autoplay playsinline style="display:none"></video>
        <canvas id="canvas" style="display:none"></canvas>
        <img id="fotoPreview" src="" alt="Preview" style="display:none">
        
        <div class="controles-camera">
            <button type="button" class="btn-camera" onclick="iniciarCamera()">üì∏ ABRIR C√ÇMERA</button>
            <button type="button" class="btn-capturar" id="btnCapturar" onclick="tirarFoto()" style="display:none">üîò CAPTURAR</button>
            <button type="button" class="btn-restore" onclick="limparFoto()" style="display:none" id="btnLimpar">üóëÔ∏è REMOVER</button>
        </div>
        <input type="hidden" id="fotoBase64">
    </div>

    <div class="bloco-titulo">3. CONTROLE DE SA√çDA (RUMB)</div>
    <div class="grid-campos">
      <div class="campo-grupo"><label>DATA DA ATIVIDADE</label><input type="date" id="dataAt" required></div>
      <div class="campo-grupo"><label>DATA DA CAUTELA</label><input type="date" id="dataC" required></div>
      <div class="campo-grupo"><label>HORA</label><input type="time" id="horaC" required></div>
      <div class="campo-grupo" style="flex-grow: 2;"><label style="color: #FF851B;">RUMB (QUARTILHEIRO)</label><input type="text" id="rumb" required placeholder="Quem entrega..."></div>
    </div>

    <div class="btn-area">
      <button type="submit" class="btn-salvar">üíæ REGISTRAR</button>
      <button type="button" class="btn-filter" onclick="mostrarAbertas()">üî¥ S√ì ABERTAS</button>
      <button type="button" class="btn-filter" onclick="render()">üìò TODAS</button>
      <button type="button" class="btn-print" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>
      <button type="button" class="btn-backup" onclick="exportarBackup()">‚¨áÔ∏è BACKUP</button>
      <input type="file" id="fileBackup" style="display:none" onchange="importarBackup(this)">
      <button type="button" class="btn-restore" onclick="document.getElementById('fileBackup').click()">‚¨ÜÔ∏è RESTAURAR</button>
    </div>
  </form>
</div>

<div class="search-container">
  <input type="text" id="inputBusca" placeholder="üîç BUSCAR (RG, Nome, Patrim√¥nio...)" onkeyup="filtrarTabela()">
</div>

<div class="table-wrapper">
  <table id="tabela">
    <thead>
      <tr>
        <th style="background:#001f3f; width: 50px;">FOTO</th>
        <th colspan="3">POLICIAL</th>
        <th colspan="4">MATERIAL</th>
        <th colspan="3" style="background:#FF851B; color: black;">SA√çDA</th>
        <th colspan="3" style="background:#15803d;">DEVOLU√á√ÉO</th>
        <th style="width: 80px;">A√á√ÉO</th>
      </tr>
      <tr>
        <th>IMG</th>
        <th>GH</th><th>RG</th><th>NOME</th>
        <th>PATR.</th><th>TIPO</th><th>PESO (g)</th><th>VAL.</th>
        <th>DATA</th><th>HORA</th><th>RUMB</th>
        <th>DATA</th><th>HORA</th><th>RUMB</th>
        <th>BAIXA</th>
      </tr>
    </thead>
    <tbody id="tabelaCorpo"></tbody>
  </table>
</div>

<script>
// --- BANCO DE DADOS ---
const databaseEfetivo = [
  { gh: "SUB PM", rg: "68831", nome: "GOMES" },
  { gh: "CB PM", rg: "101823", nome: "S. LEMOS" },
  { gh: "SD PM", rg: "110297", nome: "L. BARBOSA" },
  { gh: "CB PM", rg: "106260", nome: "BAPTISTA" },
  { gh: "3¬∫ SGT PM", rg: "91071", nome: "DIAS" },
  { gh: "CB PM", rg: "108786", nome: "TORRES" },
  { gh: "3¬∫ SGT PM", rg: "99488", nome: "DE PAULA" },
  { gh: "3¬∫ SGT PM", rg: "91665", nome: "R. ALCANTARA" },
  { gh: "3¬∫ SGT PM", rg: "100032", nome: "R. LACERDA" },
  { gh: "1¬∫ SGT PM", rg: "77614", nome: "ALZIR" },
  { gh: "SUBTEN PM", rg: "66381", nome: "J. MARCELO" },
  { gh: "3¬∫ SGT PM", rg: "94010", nome: "R. SIM√ïES" },
  { gh: "3¬∫ SGT PM", rg: "97196", nome: "DAN" },
  { gh: "CB PM", rg: "106561", nome: "MARCOS" },
  { gh: "3¬∫ SGT PM", rg: "99242", nome: "ADRIEL" },
  { gh: "CB PM", rg: "105249", nome: "R. FILHO" },
  { gh: "CB PM", rg: "102712", nome: "JOAQUIM" },
  { gh: "3¬∫ SGT PM", rg: "100360", nome: "ULISSES" },
  { gh: "CB PM", rg: "105375", nome: "RANGEL" },
  { gh: "CB PM", rg: "102181", nome: "JUNIOR" },
  { gh: "CB PM", rg: "106533", nome: "CORTEZ" },
  { gh: "3¬∫ SGT PM", rg: "98121", nome: "JOHNATHAN" },
  { gh: "3¬∫ SGT PM", rg: "96990", nome: "CLEISON" },
  { gh: "CB PM", rg: "104197", nome: "DA SILVA" },
  { gh: "3¬∫ SGT PM", rg: "98408", nome: "NASCIMENTO" },
  { gh: "3¬∫ SGT PM", rg: "93752", nome: "CARDOSO" },
  { gh: "2¬∫ SGT PM", rg: "85458", nome: "SANTOS" },
  { gh: "CB PM", rg: "107510", nome: "DA SILVA" },
  { gh: "SD PM", rg: "110796", nome: "ERICA" },
  { gh: "2¬∫ SGT PM", rg: "83708", nome: "A. MENDES" },
  { gh: "3¬∫ SGT PM", rg: "98607", nome: "SOUZA" },
  { gh: "CB PM", rg: "102704", nome: "J. ANDR√â" },
  { gh: "CB PM", rg: "106351", nome: "M. ARAUJO" },
  { gh: "CB PM", rg: "103727", nome: "BIZONI" },
  { gh: "3¬∫ SGT PM", rg: "93998", nome: "F. PERES" },
  { gh: "CB PM", rg: "107520", nome: "T. RODRIGUES" },
  { gh: "CB PM", rg: "107561", nome: "COUTINHO" },
  { gh: "CB PM", rg: "108292", nome: "JULIANO" },
  { gh: "SD PM", rg: "110387", nome: "JOSU√â" },
  { gh: "CB PM", rg: "108824", nome: "CARMO" },
  { gh: "CB PM", rg: "107805", nome: "M. PAULO" },
  { gh: "3¬∫ SGT PM", rg: "98339", nome: "SOUZA" },
  { gh: "3¬∫ SGT PM", rg: "95629", nome: "FULLY" },
  { gh: "CB PM", rg: "104953", nome: "PINHEIRO" },
  { gh: "CB PM", rg: "103051", nome: "TIRADENTES" },
  { gh: "CB PM", rg: "104291", nome: "FELIX" },
  { gh: "2¬∫ SGT PM", rg: "86615", nome: "ISAIAS" },
  { gh: "1¬∫ SGT PM", rg: "73888", nome: "COIMBRA" },
  { gh: "3¬∫ SGT PM", rg: "93331", nome: "FERREIRA" },
  { gh: "3¬∫ SGT PM", rg: "98596", nome: "VIDAL" },
  { gh: "CB PM", rg: "108190", nome: "UERBERT" },
  { gh: "CB PM", rg: "102190", nome: "D. SILVA" },
  { gh: "SD PM", rg: "110594", nome: "JULIANA FERREIRA" },
  { gh: "SUBTEN PM", rg: "65727", nome: "SANTANA" },
  { gh: "CB PM", rg: "105341", nome: "AZEVEDO" },
  { gh: "3¬∫ SGT PM", rg: "100228", nome: "MIRANDA" },
  { gh: "3¬∫ SGT PM", rg: "99791", nome: "ALMEIDA" },
  { gh: "CB PM", rg: "105284", nome: "LEONARDO" },
  { gh: "CB PM", rg: "109067", nome: "CAMILO" },
  { gh: "CB PM", rg: "106467", nome: "L. SILVA" },
  { gh: "SD PM", rg: "109738", nome: "MARIANO" },
  { gh: "CB PM", rg: "105248", nome: "DE SOUZA" },
  { gh: "3¬∫ SGT PM", rg: "93168", nome: "F. ABREU" },
  { gh: "CB PM", rg: "109109", nome: "RODRIGUES" },
  { gh: "SD PM", rg: "110470", nome: "TELES" },
  { gh: "CB PM", rg: "108677", nome: "√âDVAN" },
  { gh: "3¬∫ SGT PM", rg: "91049", nome: "JHONATHAN" },
  { gh: "2¬∫ SGT PM", rg: "86367", nome: "REGALDINO" },
  { gh: "2¬∫ SGT PM", rg: "85426", nome: "BRITO" },
  { gh: "3¬∫ SGT PM", rg: "93606", nome: "A. ALCANTARA" },
  { gh: "CB PM", rg: "109510", nome: "MAGANO" },
  { gh: "CB PM", rg: "109414", nome: "BIANCHI" },
  { gh: "SD PM", rg: "109754", nome: "CAMELO" },
  { gh: "SUBTEN PM", rg: "70372", nome: "MENDES" },
  { gh: "SD PM", rg: "110433", nome: "D. SANTOS" },
  { gh: "3¬∫ SGT PM", rg: "95714", nome: "MALAQUIAS" },
  { gh: "SUBTEN PM", rg: "76452", nome: "WAGNER" },
  { gh: "3¬∫ SGT PM", rg: "93081", nome: "GUEDES" },
  { gh: "3¬∫ SGT PM", rg: "92119", nome: "CAIO" },
  { gh: "3¬∫ SGT PM", rg: "100000", nome: "ALACRINO" },
  { gh: "3¬∫ SGT PM", rg: "99164", nome: "R. MACHADO" },
  { gh: "3¬∫ SGT PM", rg: "91783", nome: "CHARLES" },
  { gh: "CB PM", rg: "106348", nome: "SOARES" },
  { gh: "3¬∫ SGT PM", rg: "92732", nome: "MARCIO ESTEV√ÉO" },
  { gh: "CB PM", rg: "105377", nome: "F. RIBEIRO" },
  { gh: "SD PM", rg: "108664", nome: "SOUSA SILVA" },
  { gh: "CB PM", rg: "105374", nome: "LAIA" },
  { gh: "3¬∫ SGT PM", rg: "92490", nome: "VALIM" },
  { gh: "CB PM", rg: "106650", nome: "MATHEUS" },
  { gh: "3¬∫ SGT PM", rg: "96287", nome: "RODRIGUES" },
  { gh: "2¬∫ SGT PM", rg: "85664", nome: "DENILSON" },
  { gh: "3¬∫ SGT PM", rg: "92258", nome: "DOMINGOS" },
  { gh: "3¬∫ SGT PM", rg: "93341", nome: "L. FRANCISCO" },
  { gh: "SD PM", rg: "109908", nome: "TRIUMPHO" },
  { gh: "3¬∫ SGT PM", rg: "91131", nome: "CONDE" },
  { gh: "CB PM", rg: "101752", nome: "TRINDADE" },
  { gh: "3¬∫ SGT PM", rg: "91115", nome: "ITALO" },
  { gh: "3¬∫ SGT PM", rg: "96003", nome: "JONATHA" },
  { gh: "CB PM", rg: "105391", nome: "HENRIQUE" },
  { gh: "CB PM", rg: "106037", nome: "CAIQUE" },
  { gh: "3¬∫ SGT PM", rg: "98202", nome: "CRISTIANO" },
  { gh: "3¬∫ SGT PM", rg: "99226", nome: "M. JUNIOR" },
  { gh: "3¬∫ SGT PM", rg: "96541", nome: "SILVEIRA" },
  { gh: "2¬∫ SGT PM", rg: "85995", nome: "VINICIUS" }
];

function initAutocomplete() {
  const dlRg = document.getElementById('lista-rgs');
  const dlNome = document.getElementById('lista-nomes');
  databaseEfetivo.forEach(p => {
    const optR = document.createElement('option');
    optR.value = p.rg; optR.label = `${p.nome} (${p.gh})`; dlRg.appendChild(optR);
    const optN = document.createElement('option');
    optN.value = p.nome; optN.label = `${p.gh} - RG: ${p.rg}`; dlNome.appendChild(optN);
  });
}

const inputRg = document.getElementById('rg');
const inputNome = document.getElementById('nome');
const inputGh = document.getElementById('gh');

inputRg.addEventListener('input', function() {
  const val = this.value;
  const found = databaseEfetivo.find(p => p.rg === val);
  if (found) { inputNome.value = found.nome; inputGh.value = found.gh; }
});
inputNome.addEventListener('input', function() {
  const val = this.value;
  const found = databaseEfetivo.find(p => p.nome === val);
  if (found) { inputRg.value = found.rg; inputGh.value = found.gh; }
});

initAutocomplete();

// --- L√ìGICA DA C√ÇMERA ---
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const fotoPreview = document.getElementById('fotoPreview');
const fotoBase64 = document.getElementById('fotoBase64');
let streamCamera = null;

async function iniciarCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        streamCamera = stream;
        video.srcObject = stream;
        video.style.display = 'block';
        fotoPreview.style.display = 'none';
        document.getElementById('btnCapturar').style.display = 'inline-block';
        document.getElementById('btnLimpar').style.display = 'none';
    } catch (err) {
        alert("Erro ao acessar c√¢mera: " + err + "\nVerifique se est√° usando HTTPS ou rodando localmente.");
    }
}

function tirarFoto() {
    if (!streamCamera) return;
    const width = 320; 
    const height = video.videoHeight / (video.videoWidth/width);
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, width, height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
    fotoBase64.value = dataUrl;
    fotoPreview.src = dataUrl;
    video.style.display = 'none';
    fotoPreview.style.display = 'block';
    streamCamera.getTracks().forEach(track => track.stop());
    document.getElementById('btnCapturar').style.display = 'none';
    document.getElementById('btnLimpar').style.display = 'inline-block';
}

function limparFoto() {
    fotoBase64.value = "";
    fotoPreview.style.display = 'none';
    document.getElementById('btnLimpar').style.display = 'none';
}

// --- ESCALA RUMB ---
const escalaRUMB = [
  { nome: "LACERDA", inicio: "2026-01-28T05:00", fim: "2026-01-28T17:00" },
  { nome: "R. SIM√ïES", inicio: "2026-01-28T17:00", fim: "2026-01-29T05:00" }
];

function obterRUMBAtual() {
  const agora = new Date();
  const turno = escalaRUMB.find(e => agora >= new Date(e.inicio) && agora <= new Date(e.fim));
  return turno ? turno.nome : "FORA DA ESCALA";
}

// --- SISTEMA ---
const form = document.getElementById("formCautela");
const tabela = document.querySelector("#tabelaCorpo");
let dados = JSON.parse(localStorage.getItem("livroCautela_GAS")) || [];

form.onsubmit = e => {
  e.preventDefault();
  
  const novo = {
    gh: document.getElementById('gh').value.toUpperCase(),
    rg: document.getElementById('rg').value,
    nome: document.getElementById('nome').value.toUpperCase(),
    patrimonio: document.getElementById('patrimonio').value.toUpperCase(),
    modelo: document.getElementById('modelo').value,
    peso: document.getElementById('peso').value, // SALVA O PESO
    validade: document.getElementById('validade').value,
    foto: document.getElementById('fotoBase64').value,
    dataAt: document.getElementById('dataAt').value, 
    dataC: document.getElementById('dataC').value,
    horaC: document.getElementById('horaC').value,
    rumb: document.getElementById('rumb').value.toUpperCase(),
    status: "Cautelado"
  };

  const existeAberta = dados.some(d => d.rg === novo.rg && d.status === "Cautelado");
  if (existeAberta) { alert("ATEN√á√ÉO: Este policial j√° possui cautela em aberto."); return; }
  
  try {
      dados.push(novo);
      salvar(); render(); form.reset(); limparFoto();
      document.getElementById('rg').focus();
  } catch (err) {
      alert("Mem√≥ria cheia! Exporte um backup e limpe os dados.");
  }
};

function entregar(index) {
  const sugestao = obterRUMBAtual();
  const nomeRumb = prompt("Quem recebe o material?", sugestao);
  if (nomeRumb === null) return;

  const agora = new Date();
  dados[index].dataE = agora.toLocaleDateString('pt-BR');
  dados[index].horaE = agora.toLocaleTimeString('pt-BR').slice(0,5);
  dados[index].rumbEntrega = nomeRumb.toUpperCase();
  dados[index].status = "Entregue";
  salvar(); render();
}

function salvar() { localStorage.setItem("livroCautela_GAS", JSON.stringify(dados)); }

function filtrarTabela() {
  const termo = document.getElementById('inputBusca').value.toUpperCase();
  const linhas = document.querySelectorAll('#tabelaCorpo tr');
  linhas.forEach(linha => {
      const textoLinha = linha.innerText.toUpperCase();
      linha.style.display = textoLinha.includes(termo) ? '' : 'none';
  });
}

function render(filtroAbertas = false) {
  tabela.innerHTML = "";
  const listaExibicao = filtroAbertas ? dados.filter(d => d.status === "Cautelado") : dados;
  
  listaExibicao.slice().reverse().forEach((d) => {
    const indexReal = dados.indexOf(d);
    const dataCFormatada = d.dataC.split('-').reverse().join('/');
    const imgTag = d.foto ? `<img src="${d.foto}" class="img-tabela" onclick="var win=window.open();win.document.write('<img src=${d.foto} style=width:100%>')">` : '<span style="color:#aaa">S/ FOTO</span>';

    const tr = document.createElement("tr");
    if(d.status === "Entregue") { tr.style.opacity = "0.6"; tr.style.background = "#e0ffe0"; }
    
    // LINHA DA TABELA ATUALIZADA COM O PESO
    tr.innerHTML = `
      <td>${imgTag}</td>
      <td>${d.gh}</td> <td>${d.rg}</td> <td style="text-align:left; font-weight:bold">${d.nome}</td>
      <td>${d.patrimonio}</td> <td>${d.modelo}</td> <td>${d.peso || "-"}</td> <td>${d.validade}</td>
      <td>${dataCFormatada}</td> <td>${d.horaC}</td> <td style="color:#0074D9; font-weight:bold">${d.rumb}</td>
      <td>${d.dataE || "-"}</td> <td>${d.horaE || "-"}</td> <td style="color:#15803d; font-weight:bold">${d.rumbEntrega || "-"}</td>
      <td>${d.status === "Cautelado" ? `<button class="btn-baixa" onclick="entregar(${indexReal})">BAIXAR</button>` : "OK"}</td>`;
    tabela.appendChild(tr);
  });
  filtrarTabela();
}

function mostrarAbertas() { render(true); }

function exportarBackup() {
  const blob = new Blob([JSON.stringify(dados, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Livro_Gas_RUMB-${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.json`;
  a.click();
}

function importarBackup(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    if(confirm("Substituir dados atuais pelo backup?")) {
        try { dados = JSON.parse(e.target.result); salvar(); render(); alert("Importado!"); }
        catch(err) { alert("Arquivo inv√°lido."); }
    }
  };
  reader.readAsText(file);
}

document.getElementById('dataAt').valueAsDate = new Date();
document.getElementById('dataC').valueAsDate = new Date();
document.getElementById('horaC').value = new Date().toTimeString().slice(0,5);

render();
</script>
</body>
</html>